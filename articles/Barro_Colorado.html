<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>`coalesc_abc` function with a site-species matrix: example with Barro-Colorado dataset. • ecolottery</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="`coalesc_abc` function with a site-species matrix: example with Barro-Colorado dataset.">
<meta property="og:description" content="ecolottery">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ecolottery</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Barro_Colorado.html">`coalesc_abc` function with a site-species matrix: example with Barro-Colorado dataset.</a>
    </li>
    <li>
      <a href="../articles/coalesc_vignette.html">Appendix 1: basic functions and examples</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/frmunoz/ecolottery/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Barro_Colorado_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>
<code>coalesc_abc</code> function with a site-species matrix: example with Barro-Colorado dataset.</h1>
                        <h4 data-toc-skip class="author">François MUNOZ and Pierre DENELLE</h4>
            
            <h4 data-toc-skip class="date">2021-04-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/frmunoz/ecolottery/blob/master/vignettes/Barro_Colorado.Rmd" class="external-link"><code>vignettes/Barro_Colorado.Rmd</code></a></small>
      <div class="hidden name"><code>Barro_Colorado.Rmd</code></div>

    </div>

    
    
<p>This vignette corresponds to the latest version of the Appendix 3 of F.Munoz et al. paper.</p>
<div id="appendix-3-abc-estimation-of-neutral-parameters-in-barro-colorado-island-rainforest-using-coalescent-based-simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#appendix-3-abc-estimation-of-neutral-parameters-in-barro-colorado-island-rainforest-using-coalescent-based-simulation" class="anchor"></a>Appendix 3: ABC estimation of neutral parameters in Barro Colorado Island rainforest, using coalescent-based simulation</h1>
<p>We illustrate here how to use coalescent-based simulation to estimate neutral parameters of regional biodiversity dynamics, <span class="math inline">\(\theta\)</span>, and local migration rate, <span class="math inline">\(m\)</span>, from observed patterns of taxonomic diversity within and between communities.</p>
<p>Neutral theory proved successful to predict patterns of species diversity in tropical forests <span class="citation">[@L1528]</span>, while other studies also emphasized the influence of niche-based processes <span class="citation">[@1643]</span>.<br>
With coalescent-based modelling, it is possible to address the relative ability of purely neutral and environmental filtering models to explain patterns of biodiversity, using the Approximate Bayesian Computation (ABC) approach implemented in <em>ecolottery</em>.</p>
<p>Barro Colorado Island is a 50ha lowland rainforest plot established in Panama. It has become a flagship case study to test competing theories of community assembly in tropical forests. The dataset available in <em>vegan</em> package includes a census of tree species above 10 cm DBH in 1ha subplots.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/frmunoz/ecolottery" class="external-link">ecolottery</a></span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org" class="external-link">vegan</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">BCI</span><span class="op">)</span>
<span class="co"># Size (= number of individual trees) of subplots</span>
<span class="va">comm.size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">BCI</span><span class="op">)</span>
<span class="co"># Minimum subplot size</span>
<span class="va">comm.size.min</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">comm.size</span><span class="op">)</span></code></pre></div>
<p>For sake of simplicity in joint analyses of diversity patterns across subplots, we first subsample the subplots to have the same minimum subplot size.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Rarefy to minimum sample size</span>
<span class="va">bci.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/rarefy.html" class="external-link">rrarefy</a></span><span class="op">(</span><span class="va">BCI</span>, sample <span class="op">=</span> <span class="va">comm.size.min</span><span class="op">)</span></code></pre></div>
<p>We consider a set of summary statistics representing for each subplot the local richness, local Shannon diversity, and the average Bray-Curtis beta diversity with other subplots.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">betapart</span><span class="op">)</span>
<span class="co"># Compute diversity indices</span>
<span class="va">rich.obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bci.res</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">shan.obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bci.res</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/diversity.html" class="external-link">diversity</a></span><span class="op">(</span><span class="va">x</span>, index <span class="op">=</span> <span class="st">"shannon"</span><span class="op">)</span><span class="op">)</span>
<span class="va">beta.obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">beta.pair.abund</span><span class="op">(</span><span class="va">bci.res</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span><span class="op">$</span><span class="va">beta.bray</span>
<span class="va">stats.obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rich.obs</span>, <span class="va">shan.obs</span>, <span class="va">beta.obs</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">stats.obs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rich"</span>, <span class="st">"shan"</span>, <span class="st">"beta"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span></code></pre></div>
<p>To estimate the theta and m parameters of neutral dynamics, we consider a vector of 2.10^5 values drawn from a prior uniform distribution.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m.samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="fl">10</span><span class="op">^</span><span class="fl">5</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">theta.samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="fl">10</span><span class="op">^</span><span class="fl">5</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<p>Parallel computing can be used to perform the simulations, by using multiple cores in desktops, or multiple clusters. The parallel package allows handling parallel computing.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="co"># Start up a parallel cluster</span>
<span class="va">parallelCluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">parallelCluster</span><span class="op">)</span>
<span class="co"># Function to perform simulations</span>
<span class="va">mkWorker</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m.samp</span>, <span class="va">theta.samp</span>, <span class="va">J</span><span class="op">)</span>
<span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/frmunoz/ecolottery" class="external-link">ecolottery</a></span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">untb</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">m.samp</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">theta.samp</span><span class="op">)</span>
  <span class="va">summCalc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">m.samp</span>, <span class="va">theta.samp</span>, <span class="va">J</span><span class="op">)</span>
  <span class="op">{</span>
    <span class="va">pool.samp</span> <span class="op">&lt;-</span> <span class="fu">ecolottery</span><span class="fu">::</span><span class="fu"><a href="../reference/coalesc.html">coalesc</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="va">J</span>, theta <span class="op">=</span> <span class="va">theta.samp</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">pool</span>
    <span class="va">meta.samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pool.samp</span><span class="op">$</span><span class="va">sp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">meta.samp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pool.samp</span><span class="op">$</span><span class="va">sp</span><span class="op">)</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span>
    <span class="op">{</span>
      <span class="va">comm.samp</span> <span class="op">&lt;-</span> <span class="fu">ecolottery</span><span class="fu">::</span><span class="fu"><a href="../reference/coalesc.html">coalesc</a></span><span class="op">(</span><span class="va">J</span>, <span class="va">m.samp</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, pool <span class="op">=</span> <span class="va">pool.samp</span><span class="op">)</span>;
      <span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">comm.samp</span><span class="op">$</span><span class="va">com</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
      <span class="va">meta.samp</span><span class="op">[</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tab</span>
    <span class="op">}</span>
    <span class="va">rich.samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">meta.samp</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
    <span class="va">shan.samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">meta.samp</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/vegan/man/diversity.html" class="external-link">diversity</a></span><span class="op">(</span><span class="va">x</span>, index <span class="op">=</span> <span class="st">"shannon"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">beta.samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">betapart</span><span class="fu">::</span><span class="fu">beta.pair.abund</span><span class="op">(</span><span class="va">meta.samp</span><span class="op">)</span>,
                        <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
    <span class="op">)</span><span class="op">$</span><span class="va">beta.bray</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sum.stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rich.samp</span>, <span class="va">shan.samp</span>, <span class="va">beta.samp</span><span class="op">)</span>,
                param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">m.samp</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, <span class="va">theta.samp</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">worker</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">summCalc</span><span class="op">(</span><span class="va">j</span>, <span class="va">m.samp</span>, <span class="va">theta.samp</span>, <span class="va">J</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">worker</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The function mkWorker will be used in parallel instances of R to perform the simulations. For each values of m and theta the summary statistics are calculated and returned. The overall set of statistics and corresponding parameter values are stored in a list.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">modelbci</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">parallelCluster</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">^</span><span class="fl">5</span>, <span class="fu">mkWorker</span><span class="op">(</span><span class="va">m.samp</span>, <span class="va">theta.samp</span>, <span class="va">comm.size.min</span><span class="op">)</span><span class="op">)</span>
<span class="co"># IMPORTANT</span>
<span class="co"># Shutdown cluster after calculation</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">parallelCluster</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">parallelCluster</span><span class="op">)</span>
  <span class="va">parallelCluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># Summary statistics and parameter values are extracted</span>
<span class="co"># and stored in matrices</span>
<span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">modelbci</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">sum.stats</span><span class="op">)</span><span class="op">)</span>
<span class="va">stats.sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">stats</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>
<span class="va">stats.mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">stats</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>
<span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">stats</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">stats.mean</span><span class="op">)</span><span class="op">/</span><span class="va">stats.sd</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rich"</span>, <span class="st">"shan"</span>, <span class="st">"beta"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span>

<span class="va">stats.obs</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">stats.obs</span><span class="op">-</span><span class="va">stats.mean</span><span class="op">)</span><span class="op">/</span><span class="va">stats.sd</span>
<span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">modelbci</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">param</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"theta"</span><span class="op">)</span></code></pre></div>
<p>Then we use the abc function from package abc to estimate the parameters in observed rainforest subplots.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">abc</span><span class="op">)</span>
<span class="va">bci.abc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/abc/man/abc.html" class="external-link">abc</a></span><span class="op">(</span>target <span class="op">=</span> <span class="va">stats.obs</span>, param <span class="op">=</span> <span class="va">param</span>, sumstat <span class="op">=</span> <span class="va">stats</span>, tol <span class="op">=</span> <span class="fl">0.01</span>, method <span class="op">=</span> <span class="st">"neuralnet"</span><span class="op">)</span></code></pre></div>
<p>The function  encompasses the steps of simulation and ABC analysis. The previous calculations can thus be performed using the following command.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define the function providing the summary statistics</span>
<span class="va">f.sumstats</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tab</span><span class="op">)</span>
<span class="op">{</span>
  <span class="va">rich</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">tab</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
  <span class="va">shan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">tab</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/vegan/man/diversity.html" class="external-link">diversity</a></span><span class="op">(</span><span class="va">x</span>, index<span class="op">=</span><span class="st">"shannon"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">betapart</span><span class="fu">::</span><span class="fu">beta.pair.abund</span><span class="op">(</span><span class="va">tab</span><span class="op">)</span>,
                 <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">beta.bray</span>
  <span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rich</span>, <span class="va">shan</span>, <span class="va">beta</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rich"</span>, <span class="st">"shan"</span>, <span class="st">"beta"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Perform the simulations and the ABC analysis</span>
<span class="va">bci.abc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coalesc_abc.html">coalesc_abc</a></span><span class="op">(</span><span class="va">bci.res</span>, multi <span class="op">=</span> <span class="st">"tab"</span>, traits <span class="op">=</span> <span class="cn">NULL</span>,
                       f.sumstats <span class="op">=</span> <span class="va">f.sumstats</span>, params <span class="op">=</span> <span class="cn">NULL</span>,
                       theta.max <span class="op">=</span> <span class="fl">100</span>, nb.samp <span class="op">=</span> <span class="fl">100</span>, tol <span class="op">=</span> <span class="fl">0.01</span>,
                       pkg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"vegan"</span>,<span class="st">"betapart"</span><span class="op">)</span>, parallel <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
<p>bci.abc then includes the matrix of parameter values (par output), the matrix of simulated statistics values (ss output) and an abc object including the results of ABC analysis. To test if we can correctly infer <em>m</em> and <em>theta</em> from the chosen set of summary statistics, we can perform cross validation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/abc/man/cv4abc.html" class="external-link">cv4abc</a></span><span class="op">(</span>param <span class="op">=</span> <span class="va">bci.abc</span><span class="op">$</span><span class="va">par</span>, sumstat <span class="op">=</span> <span class="va">bci.abc</span><span class="op">$</span><span class="va">ss</span>,
             nval <span class="op">=</span> <span class="fl">500</span>, tols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"neuralnet"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cv</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bci.abc</span><span class="op">$</span><span class="va">abc</span>, param<span class="op">=</span><span class="va">bci.abc</span><span class="op">$</span><span class="va">par</span><span class="op">)</span></code></pre></div>
<p>Three colors, yellow, orange and red, represent results of cross-validation for different tolerance levels in ABC analysis, 1, 10^-1 and 10^-2, respectively. The plot indicates that good estimation of the parameters can be obtained with the selected tolerance levels We can then reliably estimate the parameters from observed diversity patterns at Barro Colorado Island.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">bci.abc</span><span class="op">$</span><span class="va">abc</span><span class="op">)</span></code></pre></div>
<p>We found 95% confidence interval of [52; 54] for theta, compared to thheta = 50 in (Hubbell 2001). We found an interval of [0.22; 0.24] for m. While it is somewhat larger that the estimated m = 0.1 in (Hubbell 2001), it is close to the estimation of (Etienne &amp; Olff 2004), m = 0.2, and still lower than the estimation of (Condit et al. 2012), m = 0.38, which acknowledged the census of smaller trees. While previous studies mostly addressed migration-drift in the whole 50-ha plot compared to a regional background, our summary statistics here quantifies species turnover and variation of local diversity among the 1-ha subplots. A larger estimate of m can then reflect the fact that <em>beta</em> diversity is lower than expected with m = 0.1, possibly under the influence of greater replacement dynamics within the plot than between the plot and its regional background. A next step of analysis could be to incorporate in simulations the influence of environmental variation across subplots on community assembly, depending on the species’ ecological properties. For this purpose, the previous ABC analysis can be reproduced with additional environmental filtering and variation of the linkage of environmental filtering to functional traits, as shown in the example in main text. Comparison of the results of the two ABC analyses, one with purely neutral dynamics and one incorporating the influence of environmental filtering, can then allow testing the influence of niche-based dynamics in the dynamics of the rainforest.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by François Munoz, Matthias Grenié, Pierre Denelle, Elizabeth Barthelemy.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
